import { NextRequest, NextResponse } from 'next/server'

// å®Œæ•´çš„æ˜Ÿåº§åŒ¹é…è§„åˆ™è¡¨
const zodiacCompatibility = {
  'ç™½ç¾Šåº§': {
    'ç™½ç¾Šåº§': 85, 'é‡‘ç‰›åº§': 65, 'åŒå­åº§': 92, 'å·¨èŸ¹åº§': 68,
    'ç‹®å­åº§': 95, 'å¤„å¥³åº§': 62, 'å¤©ç§¤åº§': 88, 'å¤©èåº§': 70,
    'å°„æ‰‹åº§': 98, 'æ‘©ç¾¯åº§': 60, 'æ°´ç“¶åº§': 90, 'åŒé±¼åº§': 75
  },
  'é‡‘ç‰›åº§': {
    'ç™½ç¾Šåº§': 65, 'é‡‘ç‰›åº§': 88, 'åŒå­åº§': 70, 'å·¨èŸ¹åº§': 95,
    'ç‹®å­åº§': 72, 'å¤„å¥³åº§': 96, 'å¤©ç§¤åº§': 82, 'å¤©èåº§': 98,
    'å°„æ‰‹åº§': 65, 'æ‘©ç¾¯åº§': 92, 'æ°´ç“¶åº§': 68, 'åŒé±¼åº§': 90
  },
  'åŒå­åº§': {
    'ç™½ç¾Šåº§': 92, 'é‡‘ç‰›åº§': 70, 'åŒå­åº§': 85, 'å·¨èŸ¹åº§': 75,
    'ç‹®å­åº§': 92, 'å¤„å¥³åº§': 78, 'å¤©ç§¤åº§': 95, 'å¤©èåº§': 72,
    'å°„æ‰‹åº§': 90, 'æ‘©ç¾¯åº§': 68, 'æ°´ç“¶åº§': 96, 'åŒé±¼åº§': 75
  },
  'å·¨èŸ¹åº§': {
    'ç™½ç¾Šåº§': 68, 'é‡‘ç‰›åº§': 95, 'åŒå­åº§': 75, 'å·¨èŸ¹åº§': 88,
    'ç‹®å­åº§': 75, 'å¤„å¥³åº§': 90, 'å¤©ç§¤åº§': 72, 'å¤©èåº§': 95,
    'å°„æ‰‹åº§': 65, 'æ‘©ç¾¯åº§': 85, 'æ°´ç“¶åº§': 70, 'åŒé±¼åº§': 98
  },
  'ç‹®å­åº§': {
    'ç™½ç¾Šåº§': 95, 'é‡‘ç‰›åº§': 72, 'åŒå­åº§': 92, 'å·¨èŸ¹åº§': 75,
    
    'ç‹®å­åº§': 90, 'å¤„å¥³åº§': 75, 'å¤©ç§¤åº§': 92, 'å¤©èåº§': 78,
    'å°„æ‰‹åº§': 96, 'æ‘©ç¾¯åº§': 70, 'æ°´ç“¶åº§': 88, 'åŒé±¼åº§': 82
  },
  'å¤„å¥³åº§': {
    'ç™½ç¾Šåº§': 62, 'é‡‘ç‰›åº§': 96, 'åŒå­åº§': 78, 'å·¨èŸ¹åº§': 90,
    'ç‹®å­åº§': 75, 'å¤„å¥³åº§': 85, 'å¤©ç§¤åº§': 78, 'å¤©èåº§': 92,
    'å°„æ‰‹åº§': 70, 'æ‘©ç¾¯åº§': 95, 'æ°´ç“¶åº§': 75, 'åŒé±¼åº§': 85
  },
  'å¤©ç§¤åº§': {
    'ç™½ç¾Šåº§': 88, 'é‡‘ç‰›åº§': 82, 'åŒå­åº§': 95, 'å·¨èŸ¹åº§': 72,
    'ç‹®å­åº§': 92, 'å¤„å¥³åº§': 78, 'å¤©ç§¤åº§': 85, 'å¤©èåº§': 85,
    'å°„æ‰‹åº§': 92, 'æ‘©ç¾¯åº§': 75, 'æ°´ç“¶åº§': 95, 'åŒé±¼åº§': 82
  },
  'å¤©èåº§': {
    'ç™½ç¾Šåº§': 70, 'é‡‘ç‰›åº§': 98, 'åŒå­åº§': 72, 'å·¨èŸ¹åº§': 95,
    'ç‹®å­åº§': 78, 'å¤„å¥³åº§': 92, 'å¤©ç§¤åº§': 85, 'å¤©èåº§': 90,
    'å°„æ‰‹åº§': 75, 'æ‘©ç¾¯åº§': 88, 'æ°´ç“¶åº§': 72, 'åŒé±¼åº§': 96
  },
  'å°„æ‰‹åº§': {
    'ç™½ç¾Šåº§': 98, 'é‡‘ç‰›åº§': 65, 'åŒå­åº§': 90, 'å·¨èŸ¹åº§': 65,
    'ç‹®å­åº§': 96, 'å¤„å¥³åº§': 70, 'å¤©ç§¤åº§': 92, 'å¤©èåº§': 75,
    'å°„æ‰‹åº§': 92, 'æ‘©ç¾¯åº§': 68, 'æ°´ç“¶åº§': 90, 'åŒé±¼åº§': 75
  },
  'æ‘©ç¾¯åº§': {
    'ç™½ç¾Šåº§': 60, 'é‡‘ç‰›åº§': 92, 'åŒå­åº§': 68, 'å·¨èŸ¹åº§': 85,
    'ç‹®å­åº§': 70, 'å¤„å¥³åº§': 95, 'å¤©ç§¤åº§': 75, 'å¤©èåº§': 88,
    'å°„æ‰‹åº§': 68, 'æ‘©ç¾¯åº§': 90, 'æ°´ç“¶åº§': 78, 'åŒé±¼åº§': 85
  },
  'æ°´ç“¶åº§': {
    'ç™½ç¾Šåº§': 90, 'é‡‘ç‰›åº§': 68, 'åŒå­åº§': 96, 'å·¨èŸ¹åº§': 70,
    'ç‹®å­åº§': 88, 'å¤„å¥³åº§': 75, 'å¤©ç§¤åº§': 95, 'å¤©èåº§': 72,
    'å°„æ‰‹åº§': 90, 'æ‘©ç¾¯åº§': 78, 'æ°´ç“¶åº§': 85, 'åŒé±¼åº§': 78
  },
  'åŒé±¼åº§': {
    'ç™½ç¾Šåº§': 75, 'é‡‘ç‰›åº§': 90, 'åŒå­åº§': 75, 'å·¨èŸ¹åº§': 98,
    'ç‹®å­åº§': 82, 'å¤„å¥³åº§': 85, 'å¤©ç§¤åº§': 82, 'å¤©èåº§': 96,
    'å°„æ‰‹åº§': 75, 'æ‘©ç¾¯åº§': 85, 'æ°´ç“¶åº§': 78, 'åŒé±¼åº§': 92
  }
}

function getCompatibilityScore(zodiac1: string, zodiac2: string): number {
  return zodiacCompatibility[zodiac1]?.[zodiac2] || 75
}

// æ›´ä¸°å¯Œçš„åŒ¹é…æ¶ˆæ¯
function getCompatibilityMessage(score: number): string {
  if (score >= 95) return 'å¤©ä½œä¹‹åˆï¼ä½ ä»¬çš„æ˜Ÿåº§ç›¸æ€§ç®€ç›´å®Œç¾ï¼ğŸ’«âœ¨'
  if (score >= 90) return 'éå¸¸èˆ¬é…ï¼ä½ ä»¬çš„æ˜Ÿåº§èƒ½æ“¦å‡ºç»šä¸½çš„ç«èŠ±ï¼ğŸ’–âœ¨'
  if (score >= 85) return 'å¾ˆåˆé€‚ï¼ä½ ä»¬çš„æ˜Ÿåº§ç›¸æ€§éå¸¸å¥½ï¼ğŸ’'
  if (score >= 80) return 'ç›¸å½“ä¸é”™ï¼ä½ ä»¬çš„æ˜Ÿåº§æœ‰å¾ˆå¥½çš„äº’è¡¥æ€§ï¼ğŸ’•'
  if (score >= 75) return 'è¿˜ä¸é”™å“¦ï¼ä½ ä»¬çš„æ˜Ÿåº§å¯ä»¥äº’ç›¸ç†è§£ï¼ğŸ’«'
  if (score >= 70) return 'å¯ä»¥å‘å±•ï¼è™½ç„¶æœ‰äº›æŒ‘æˆ˜ï¼Œä½†å€¼å¾—åŠªåŠ›ï¼ğŸŒŸ'
  if (score >= 65) return 'éœ€è¦æ›´å¤šåŒ…å®¹ï¼Œä½†ä¹Ÿæœ‰ç‹¬ç‰¹çš„å¸å¼•åŠ›ï¼âœ¨'
  return 'æ˜Ÿåº§ç›¸æ€§æœ‰ç‚¹è€ƒéªŒï¼Œä½†çœŸçˆ±å¯ä»¥è¶…è¶Šä¸€ï¿½ï¿½ï¿½ï¼ğŸ’'
}

export async function POST(request: NextRequest) {
  try {
    const data = await request.json()

    // éªŒè¯æ•°æ®
    if (!data?.person1?.zodiac || !data?.person2?.zodiac) {
      return new NextResponse(
        JSON.stringify({ success: false, error: 'è¯·é€‰æ‹©åŒæ–¹çš„æ˜Ÿåº§' }),
        {
          status: 400,
          headers: {
            'Content-Type': 'application/json',
          },
        }
      )
    }

    // è®¡ç®—åŒ¹é…åˆ†æ•°
    const score = getCompatibilityScore(data.person1.zodiac, data.person2.zodiac)

    // ç”Ÿæˆç»“æœ
    const result = {
      score,
      message: getCompatibilityMessage(score),
      details: {
        person1: {
          name: data.person1.name || 'ç¥ç§˜äºº1',
          zodiac: data.person1.zodiac
        },
        person2: {
          name: data.person2.name || 'ç¥ç§˜äºº2',
          zodiac: data.person2.zodiac
        }
      }
    }

    // è¿”å›ç»“æœ
    return new NextResponse(
      JSON.stringify({ success: true, result }),
      {
        status: 200,
        headers: {
          'Content-Type': 'application/json',
        },
      }
    )

  } catch (error) {
    console.error('API Error:', error)
    return new NextResponse(
      JSON.stringify({ success: false, error: 'é¢„æµ‹å¤±è´¥ï¼Œè¯·é‡è¯•' }),
      {
        status: 500,
        headers: {
          'Content-Type': 'application/json',
        },
      }
    )
  }
}
